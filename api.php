<?php
include 'function.php';if(isset($_POST['get'])&&$_POST['get']){$data=[];if(siteinfo('generator_display')||userActive()){if($_POST['get']=='batch_encode'&&$_POST['linklist']&&$_POST['url']){$linklist=$_POST['linklist'];$url=$_POST['url'];$linklist=explode("\n",$linklist);$data['linklist']=[];foreach($linklist as $key=>$val){if(preg_match('#^(https://|http://)drive.google.com#m',strtolower($val)))$val="https://drive.google.com/file/d/".get_drive_id($val);if($val){$type=($_POST['type']?'&type='.$_POST['type']:'');$host=(isset(parse_url($val)['host'])?parse_url($val)['host']:'');if(preg_match('/(?P<domain>[a-z0-9][a-z0-9\-]{1,63}\.[a-z\.]{2,6})$/i',$host,$regs)){$host=$regs['domain'];}if(!file_exists('host/'.$host.'.php')){array_push($data['linklist'],'#Error Url not supported');}else if($_POST['shortlink']=='1'&&(siteinfo('shortlink')||userActive())){$hostlist=host();$status='';foreach($hostlist as $name=>$stats){if($host==$name){$status=$stats;}}if($status=='online'){$fileurl=urltofile($val);$token=getToken(5);if($_POST['type']=="3"){if(file_exists('db/link/encoded/'.$fileurl.'.txt')){array_push($data['linklist'],$url.'/e/'.file_get_contents('db/link/encoded/'.$fileurl.'.txt'));}else if(strlen($fileurl)>255){array_push($data['linklist'],'#Error Url too long');}else{while(file_exists('db/link/short/'.$token.'.txt')){$token=getToken(5);}file_put_contents('db/link/short/'.$token.'.txt',$val);file_put_contents('db/link/encoded/'.$fileurl.'.txt',$token);array_push($data['linklist'],$url.'/e/'.$token);}}else{if(file_exists('db/link/encoded/'.$fileurl.'.txt')){array_push($data['linklist'],$url.'/d/'.file_get_contents('db/link/encoded/'.$fileurl.'.txt').$type);}else if(strlen($fileurl)>255){array_push($data['linklist'],'#Error Url too long');}else{while(file_exists('db/link/short/'.$token.'.txt')){$token=getToken(5);}file_put_contents('db/link/short/'.$token.'.txt',$val);file_put_contents('db/link/encoded/'.$fileurl.'.txt',$token);array_push($data['linklist'],$url.'/d/'.$token.$type);}}}else if($status=='offline'){array_push($data['linklist'],'#Error Url not supported');}else if($status){array_push($data['linklist'],'#Error '.$status);}else{array_push($data['linklist'],'#Error Url not supported');}}else{if($_POST['type']=="3"){array_push($data['linklist'],$url.'/embed/'.encoder($val));}else{array_push($data['linklist'],$url.'/dl/'.encoder($val).$type);}}}}}}else{$data['error']="Generator is disabled";}echo json_encode($data);}else if(get('go')){if(get('type')=="3"||get('type')=="embed")return header("Location: ".(isset($_SERVER['HTTPS'])&&$_SERVER['HTTPS']==='on'?"https":"http")."://".$_SERVER['HTTP_HOST'].(dirname($_SERVER['PHP_SELF'])=="\\"?"/":(dirname($_SERVER['PHP_SELF'])=="/"?"/":dirname($_SERVER['PHP_SELF'])."/")).'embed/'.encoder(get('go')));header("Location: ".(isset($_SERVER['HTTPS'])&&$_SERVER['HTTPS']==='on'?"https":"http")."://".$_SERVER['HTTP_HOST'].(dirname($_SERVER['PHP_SELF'])=="\\"?"/":(dirname($_SERVER['PHP_SELF'])=="/"?"/":dirname($_SERVER['PHP_SELF'])."/")).'dl/'.encoder(get('go')).(get('type')?'&type='.get('type'):''));}
?>