<?php
$file['host']="Google Drive";$cachedir=dirname(__FILE__)."/cache/";if(!file_exists($cachedir)){mkdir($cachedir,0777,true);}function Drive($link){global $cachedir;$timeout=900;$file_name=md5('AA'.$link.'A3Code');if(file_exists($cachedir.$file_name.'.cache')){$fopen=file_get_contents($cachedir.$file_name.'.cache');$data=explode('@@',$fopen);$now=gmdate('Y-m-d H:i:s',time()+3600*(+7+date('I')));$times=strtotime($now)-$data[0];if($times>=$timeout||!$data[1]){$id=get_drive_id($link);$linkdown=trim(getlink($id));$create_cache=gd_cache($link,$linkdown);$arrays=explode('|',$create_cache);$cache=$arrays[0];}else{$cache=$data[1];}}else{$id=get_drive_id($link);$linkdown=trim(getlink($id));$create_cache=gd_cache($link,$linkdown);$arrays=explode('|',$create_cache);$cache=$arrays[0];}return $cache;}function getlink($id){global $cachedir;global $file;$ch=curl_init("https://drive.google.com/uc?id=$id&authuser=0&export=download");curl_setopt_array($ch,array(CURLOPT_CUSTOMREQUEST=>'POST',CURLOPT_SSL_VERIFYPEER=>false,CURLOPT_POSTFIELDS=>[],CURLOPT_RETURNTRANSFER=>true,CURLOPT_ENCODING=>'gzip,deflate',CURLOPT_IPRESOLVE=>CURL_IPRESOLVE_V4,CURLOPT_HTTPHEADER=>['accept-encoding: gzip, deflate, br','content-length: 0','content-type: application/x-www-form-urlencoded;charset=UTF-8','origin: https://drive.google.com','user-agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.181 Safari/537.36','x-client-data: CKG1yQEIkbbJAQiitskBCMS2yQEIqZ3KAQioo8oBGLeYygE=','x-drive-first-party: DriveWebUi','x-json-requested: true']));$page=curl_exec($ch);$res_code=curl_getinfo($ch,CURLINFO_HTTP_CODE);curl_close($ch);if($res_code=='200'){$object=json_decode(str_replace(')]}\'','',$page));if(isset($object->downloadUrl)){return $object->downloadUrl;}else if(isset($object->disposition)){$file['error']="Google Quota limit Exceeded";}}else{$file['error']=$res_code;}}function gd_cache($link,$source){global $cachedir;global $error;if(!$error){$time=gmdate('Y-m-d H:i:s',time()+3000*(+7+date('I')));$file_name=md5('AA'.$link.'A3Code');$string=strtotime($time).'@@'.$source;$file=fopen($cachedir.$file_name.".cache",'w');fwrite($file,$string);fclose($file);}$msn=$source;return $msn;}function locheader($page){if(preg_match_all("#Location: ((.+?)download)#i",$page,$loc)){$location=$loc[1][0];return $location;}}$file['url']=get_drive_id($file['url']);$file['url']="https://drive.google.com/file/d/".$file['url']."/view";$file['download']=Drive($file['url']);if($file['down_type']!="direct"){$ch=curl_init();curl_setopt($ch,CURLOPT_URL,$file['url']);curl_setopt($ch,CURLOPT_SSL_VERIFYPEER,false);curl_setopt($ch,CURLOPT_SSL_VERIFYHOST,false);curl_setopt($ch,CURLOPT_RETURNTRANSFER,1);$page=curl_exec($ch);curl_close($ch);$file['size']=explode("itemJson: [",$page);$file['size']=explode("[]",$file['size'][1]);preg_match("#\[null,null,\"(\d+)\"\]#",$file['size'][0],$file['size']);$file['size']=byteformat($file['size'][1]);$file['type']=explode("itemJson:",$page);$file['type']=explode("}",$file['type'][1]);$file['type']=explode(",",$file['type'][0]);$file['type']=explode('/',str_replace('"','',$file['type'][11]))[1];if(preg_match("/title\" content=\"(.+?)\"/",$page,$flnm)){$file['name']=trim($flnm[1]);};}
?>